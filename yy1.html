<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>轨迹追踪系统</title>
    <style>
        /* 优化样式表 */
        html, body, #container {
            margin: 0;
            height: 100%;
            font-family: Arial, sans-serif;
        }

        #control-panel {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px 24px;
            border-radius: 25px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .control-button {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .control-button:hover {
            background: #45a049;
        }

        .loading-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .marker-label {
            background: white;
            padding: 5px 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div id='container'><div class="loading-indicator"></div> 数据加载中...</div>
    <div id="control-panel">
        <button class="control-button" id="play-button" onclick="togglePlayback()">▶ 播放</button>
        <span id="status-info">-</span>
    </div>

    <script src='https://webapi.amap.com/maps?v=2.0&key=47d57deacf67daf4fe68b31c3dcdc253'></script>
    <script>
        // 状态枚举
        const PlaybackState = {
            STOPPED: 0,
            PLAYING: 1,
            PAUSED: 2
        };

        // 配置参数
        const config = {
            animationDuration: 300,  // 动画持续时间（毫秒/点）
            maxPointsPerRequest: 600 // 每页最大点数
        };

        // 应用状态
        let state = {
            currentPage: 1,
            playbackState: PlaybackState.STOPPED,
            trajectory: [],
            timestamps: [],
            speeds: [],
            map: null,
            marker: null,
            polyline: null
        };

        // 初始化应用
        function initialize() {
            try {
                const params = parseUrlParams();
                validateParams(params);
                loadTrajectoryData(params);
            } catch (error) {
                handleError(error);
            }
        }

        // 解析URL参数
        function parseUrlParams() {
            const params = {};
            const query = location.search.substr(1).split('&');
            
            query.forEach(pair => {
                const [key, value] = pair.split('=');
                params[decodeURIComponent(key)] = decodeURIComponent(value);
            });

            return params;
        }

        // 参数验证
        function validateParams(params) {
            const required = ['ak', 'service_id', 'entity_name', 'start_time'];
            required.forEach(param => {
                if (!params[param]) throw new Error(`缺少必要参数: ${param}`);
            });
        }

        // 加载轨迹数据
        async function loadTrajectoryData(params) {
            try {
                const response = await fetchTrajectoryPage(params);
                processTrajectoryData(response);
                
                if (shouldFetchNextPage(response)) {
                    loadTrajectoryData(params);
                } else {
                    initializeMap();
                    calculateStatistics();
                }
            } catch (error) {
                handleError(error);
            }
        }

        // 获取单页轨迹数据
        function fetchTrajectoryPage(params) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                const callbackName = `jsonp_${Date.now()}`;

                window[callbackName] = response => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    response.error ? reject(response) : resolve(response);
                };

                script.src = `https://yingyan.baidu.com/api/v3/track/gettrack?
                    callback=${callbackName}&
                    coord_type_output=gcj02&
                    page_size=${config.maxPointsPerRequest}&
                    page_index=${state.currentPage++}&
                    ${new URLSearchParams(params)}`;

                script.onerror = () => reject(new Error('数据加载失败'));
                document.body.appendChild(script);
            });
        }

        // 处理轨迹数据
        function processTrajectoryData(response) {
            response.points.forEach(point => {
                state.trajectory.push([point.longitude, point.latitude]);
                state.timestamps.push(point.loc_time);
                state.speeds.push(point.speed);
            });
        }

        // 初始化地图
        function initializeMap() {
            state.map = new AMap.Map("container", {
                zoom: 15,
                center: state.trajectory[0],
                disableSocket: true
            });

            createTrajectoryLayer();
            createVehicleMarker();
            setupMapControls();
        }

        // 创建轨迹图层
        function createTrajectoryLayer() {
            state.polyline = new AMap.Polyline({
                path: state.trajectory,
                strokeColor: "#1890ff",
                strokeWeight: 6,
                showDir: true
            });
            state.map.add(state.polyline);
            state.map.setFitView();
        }

        // 创建车辆标记
        function createVehicleMarker() {
            state.marker = new AMap.Marker({
                position: state.trajectory[0],
                content: createMarkerContent(),
                offset: new AMap.Pixel(-15, -30)
            });

            state.marker.on('moving', updateMapView);
            state.marker.on('movealong', () => {
                updatePlaybackState(PlaybackState.STOPPED);
            });

            state.map.add(state.marker);
        }

        // 更新地图视图
        function updateMapView(event) {
            state.map.setCenter(event.passedPos);
            updateMarkerLabel(event.currentIndex);
        }

        // 切换播放状态
        function togglePlayback() {
            switch (state.playbackState) {
                case PlaybackState.STOPPED:
                    startPlayback();
                    break;
                case PlaybackState.PLAYING:
                    pausePlayback();
                    break;
                case PlaybackState.PAUSED:
                    resumePlayback();
                    break;
            }
        }

        // 开始播放
        function startPlayback() {
            state.marker.moveAlong(state.trajectory, {
                duration: config.animationDuration,
                autoRotation: true
            });
            updatePlaybackState(PlaybackState.PLAYING);
        }

        // 其余优化代码...
        
        // 错误处理
        function handleError(error) {
            console.error('Error:', error);
            document.getElementById('container').innerHTML = `
                <div class="error-message">
                    <h3>数据加载失败</h3>
                    <p>${error.message}</p>
                </div>
            `;
        }

        // 初始化应用
        initialize();
    </script>
</body>
</html>
